{"version":3,"file":"mixpanel-lazy.min.js","sources":["../src/mixpanel-lazy.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Loads Mixpanel tracker.\n *\n * @copyright Copyright (c) 2021 Open LMS\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery','core/log'],\n    function($, Log) {\n\n        var self = this;\n\n        var tracker = {};\n\n        self.addAnalyticsJS = function() {\n            var dfd = $.Deferred();\n            var token = tracker.trackerInfo.token;\n            if (!token) {\n                Log.debug('Liquidus is misconfigured for Mixpanel, Token is missing.');\n                return;\n            }\n            /* eslint-disable */\n            (function(f,b){if(!b.__SV){var e,g,i,h;window.mixpanel=b;b._i=[];b.init=function(e,f,c){function g(a,d){var b=d.split(\".\");2==b.length&&(a=a[b[0]],d=b[1]);a[d]=function(){a.push([d].concat(Array.prototype.slice.call(arguments,0)))}}var a=b;\"undefined\"!==typeof c?a=b[c]=[]:c=\"mixpanel\";a.people=a.people||[];a.toString=function(a){var d=\"mixpanel\";\"mixpanel\"!==c&&(d+=\".\"+c);a||(d+=\" (stub)\");return d};a.people.toString=function(){return a.toString(1)+\".people (stub)\"};i=\"disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove\".split(\" \");\n            for(h=0;h<i.length;h++)g(a,i[h]);var j=\"set set_once union unset remove delete\".split(\" \");a.get_group=function(){function b(c){d[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));a.push([e,call2])}}for(var d={},e=[\"get_group\"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<j.length;c++)b(j[c]);return d};b._i.push([e,f,c])};b.__SV=1.2;e=f.createElement(\"script\");e.type=\"text/javascript\";e.async=!0;e.src=\"undefined\"!==typeof MIXPANEL_CUSTOM_LIB_URL?\n            MIXPANEL_CUSTOM_LIB_URL:\"file:\"===f.location.protocol&&\"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js\".match(/^\\/\\//)?\"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js\":\"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js\";g=f.getElementsByTagName(\"script\")[0];g.parentNode.insertBefore(e,g)}})(document,window.mixpanel||[]);\n            mixpanel.init(token);\n            /* eslint-enable */\n\n            if (typeof tracker.trackerInfo.trackforms !== 'undefined'\n                && tracker.trackerInfo.trackforms) {\n                trackForms();\n            }\n\n            dfd.resolve(tracker);\n            return dfd;\n        };\n\n        const trackForms = () => {\n            const pageType = typeof tracker.trackerInfo.staticShares.pageType != 'undefined' ?\n                tracker.trackerInfo.staticShares.pageType + '_' : '';\n\n            $('form').each(function(index) {\n                const currentForm = $(this);\n\n                let id = currentForm.attr('id');\n                if (typeof id === 'undefined') {\n                    id = currentForm.attr('name');\n                }\n\n                if (typeof id === 'undefined') {\n                    id = index;\n                } else {\n                    id = index + '_' + id;\n                }\n\n                id = pageType + id;\n\n                let eventProperties = {\n                    pageType: pageType,\n                    formId: id\n                };\n\n                /* global mixpanel */\n                if (!skipFormTrack(currentForm[0].baseURI, id)) {\n                    // Once the form is submitted, send the event data to Mixpanel.\n                    currentForm.on('submit', function() {\n                        mixpanel.track('Form submitted', eventProperties, {send_immediately: true});\n                        Log.debug('[mixpanel] Form Submitted Sent.');\n                    });\n                }\n            });\n        };\n\n        tracker.loadTracker = function(trackerInfo) {\n            tracker.trackerInfo = trackerInfo;\n            return self.addAnalyticsJS();\n        };\n\n        tracker.identify = function() {\n            /* global mixpanel */\n            mixpanel.identify(tracker.trackerInfo.staticShares.userHash);\n        };\n\n        tracker.trackPage = function() {\n            let data = {};\n            if (tracker.trackerInfo.staticShares.plugins) {\n                const plugins = tracker.trackerInfo.staticShares.plugins;\n                Object.entries(plugins).forEach(\n                    ([type, value]) => {\n                        // Dynamically adding property names.\n                        data['PluginsUsed_' + type] = value;\n                    });\n                delete tracker.trackerInfo.staticShares.plugins;\n            }\n            Object.entries(tracker.trackerInfo.staticShares).forEach(\n                ([type, value]) => {\n                    if (type === 'pageType'\n                        && typeof tracker.trackerInfo.pagetypeevent != 'undefined'\n                        && tracker.trackerInfo.pagetypeevent\n                    ) {\n                        return; // Page type will be appended to page event.\n                    }\n                    data[type] = value;\n                }\n            );\n            let eventId = 'Page view';\n            if (typeof tracker.trackerInfo.pagetypeevent != 'undefined'\n                && tracker.trackerInfo.pagetypeevent\n                && typeof tracker.trackerInfo.staticShares.pageType != 'undefined'\n            ) {\n                eventId += ' - ' + tracker.trackerInfo.staticShares.pageType;\n            }\n            /* global mixpanel */\n            mixpanel.track(eventId, data);\n        };\n\n        tracker.processEvent = function(dfd, metricName, data) {\n            /* global mixpanel */\n            mixpanel.track(metricName, data, {send_immediately: true}, () => {\n                dfd.resolve();\n                Log.debug('[mixpanel] Custom event Sent.');\n            });\n        };\n\n        const skipFormTrack = function(url, id) {\n            const formSkipList = tracker.trackerInfo.skipTrackForms;\n            for (let i = 0; i < formSkipList.length; i++) {\n                if (url.includes(formSkipList[i]) || id.includes(formSkipList[i])) {\n                    return true;\n                }\n            }\n            return false;\n        };\n\n        return tracker;\n    });\n"],"names":["define","$","Log","self","this","tracker","addAnalyticsJS","f","b","e","g","i","h","dfd","Deferred","token","trackerInfo","document","window","mixpanel","__SV","_i","init","c","a","d","split","length","push","concat","Array","prototype","slice","call","arguments","people","toString","j","get_group","call2_args","call2","createElement","type","async","src","MIXPANEL_CUSTOM_LIB_URL","location","protocol","match","getElementsByTagName","parentNode","insertBefore","trackforms","trackForms","resolve","debug","pageType","staticShares","each","index","currentForm","id","attr","eventProperties","formId","skipFormTrack","baseURI","on","track","send_immediately","loadTracker","identify","userHash","trackPage","data","plugins","Object","entries","forEach","_ref","value","_ref2","pagetypeevent","eventId","processEvent","metricName","url","formSkipList","skipTrackForms","includes"],"mappings":";;;;;;AAqBAA,sCAAO,CAAC,SAAS,aACb,SAASC,EAAGC,SAEJC,KAAOC,KAEPC,QAAU,GAEdF,KAAKG,eAAiB,eAQRC,EAAEC,EAAmBC,EAAEC,EAAEC,EAAEC,EAPjCC,IAAMZ,EAAEa,WACRC,MAAQV,QAAQW,YAAYD,SAC3BA,aAKKR,EAE0RU,UAFxRT,EAEiSU,OAAOC,UAAU,IAFzSC,OAAkBF,OAAOC,SAASX,EAAEA,EAAEa,GAAG,GAAGb,EAAEc,KAAK,SAASb,EAAEF,EAAEgB,YAAYb,EAAEc,EAAEC,OAAOjB,EAAEiB,EAAEC,MAAM,QAAQlB,EAAEmB,SAASH,EAAEA,EAAEhB,EAAE,IAAIiB,EAAEjB,EAAE,IAAIgB,EAAEC,GAAG,WAAWD,EAAEI,KAAK,CAACH,GAAGI,OAAOC,MAAMC,UAAUC,MAAMC,KAAKC,UAAU,UAAUV,EAAEhB,eAAuBe,EAAEC,EAAEhB,EAAEe,GAAG,GAAGA,EAAE,WAAWC,EAAEW,OAAOX,EAAEW,QAAQ,GAAGX,EAAEY,SAAS,SAASZ,OAAOC,EAAE,8BAAwBF,IAAIE,GAAG,IAAIF,GAAGC,IAAIC,GAAG,WAAkBA,GAAGD,EAAEW,OAAOC,SAAS,kBAAkBZ,EAAEY,SAAS,GAAG,kBAAkBzB,EAAE,0dAA0de,MAAM,KACr7Bd,EAAE,EAAEA,EAAED,EAAEgB,OAAOf,IAAIF,EAAEc,EAAEb,EAAEC,QAAQyB,EAAE,yCAAyCX,MAAM,KAAKF,EAAEc,UAAU,oBAAoB9B,EAAEe,GAAGE,EAAEF,GAAG,WAAWgB,WAAWL,UAAUM,MAAM,CAACjB,GAAGM,OAAOC,MAAMC,UAAUC,MAAMC,KAAKM,WAAW,IAAIf,EAAEI,KAAK,CAACnB,EAAE+B,aAAa,IAAIf,EAAE,GAAGhB,EAAE,CAAC,aAAaoB,OAAOC,MAAMC,UAAUC,MAAMC,KAAKC,UAAU,IAAIX,EAAE,EAAEA,EAAEc,EAAEV,OAAOJ,IAAIf,EAAE6B,EAAEd,WAAWE,GAAGjB,EAAEa,GAAGO,KAAK,CAACnB,EAAEF,EAAEgB,KAAKf,EAAEY,KAAK,KAAIX,EAAEF,EAAEkC,cAAc,WAAYC,KAAK,kBAAkBjC,EAAEkC,OAAM,EAAGlC,EAAEmC,IAAI,oBAAqBC,wBAC/dA,wBAAwB,UAAUtC,EAAEuC,SAASC,UAAU,gDAAgDC,MAAM,SAAS,sDAAsD,iDAAgDtC,EAAEH,EAAE0C,qBAAqB,UAAU,IAAKC,WAAWC,aAAa1C,EAAEC,IAC9RS,SAASG,KAAKP,YAGgC,IAAnCV,QAAQW,YAAYoC,YACxB/C,QAAQW,YAAYoC,YACvBC,aAGJxC,IAAIyC,QAAQjD,SACLQ,IAhBHX,IAAIqD,MAAM,oEAmBZF,WAAa,WACTG,cAA+D,IAA7CnD,QAAQW,YAAYyC,aAAaD,SACrDnD,QAAQW,YAAYyC,aAAaD,SAAW,IAAM,GAEtDvD,EAAE,QAAQyD,MAAK,SAASC,aACdC,YAAc3D,EAAEG,UAElByD,GAAKD,YAAYE,KAAK,WACR,IAAPD,KACPA,GAAKD,YAAYE,KAAK,SAItBD,QADc,IAAPA,GACFF,MAEAA,MAAQ,IAAME,GAGvBA,GAAKL,SAAWK,OAEZE,gBAAkB,CAClBP,SAAUA,SACVQ,OAAQH,IAIPI,cAAcL,YAAY,GAAGM,QAASL,KAEvCD,YAAYO,GAAG,UAAU,WACrBhD,SAASiD,MAAM,iBAAkBL,gBAAiB,CAACM,kBAAkB,IACrEnE,IAAIqD,MAAM,0CAM1BlD,QAAQiE,YAAc,SAAStD,oBAC3BX,QAAQW,YAAcA,YACfb,KAAKG,kBAGhBD,QAAQkE,SAAW,WAEfpD,SAASoD,SAASlE,QAAQW,YAAYyC,aAAae,WAGvDnE,QAAQoE,UAAY,eACZC,KAAO,MACPrE,QAAQW,YAAYyC,aAAakB,QAAS,OACpCA,QAAUtE,QAAQW,YAAYyC,aAAakB,QACjDC,OAAOC,QAAQF,SAASG,SACpBC,WAAErC,KAAMsC,YAEJN,KAAK,eAAiBhC,MAAQsC,gBAE/B3E,QAAQW,YAAYyC,aAAakB,QAE5CC,OAAOC,QAAQxE,QAAQW,YAAYyC,cAAcqB,SAC7CG,YAAEvC,KAAMsC,aACS,aAATtC,WAC+C,IAArCrC,QAAQW,YAAYkE,eAC3B7E,QAAQW,YAAYkE,gBAI3BR,KAAKhC,MAAQsC,cAGjBG,QAAU,iBACkC,IAArC9E,QAAQW,YAAYkE,eACxB7E,QAAQW,YAAYkE,oBACgC,IAA7C7E,QAAQW,YAAYyC,aAAaD,WAE3C2B,SAAW,MAAQ9E,QAAQW,YAAYyC,aAAaD,UAGxDrC,SAASiD,MAAMe,QAAST,OAG5BrE,QAAQ+E,aAAe,SAASvE,IAAKwE,WAAYX,MAE7CvD,SAASiD,MAAMiB,WAAYX,KAAM,CAACL,kBAAkB,IAAO,KACvDxD,IAAIyC,UACJpD,IAAIqD,MAAM,2CAIZU,cAAgB,SAASqB,IAAKzB,UAC1B0B,aAAelF,QAAQW,YAAYwE,mBACpC,IAAI7E,EAAI,EAAGA,EAAI4E,aAAa5D,OAAQhB,OACjC2E,IAAIG,SAASF,aAAa5E,KAAOkD,GAAG4B,SAASF,aAAa5E,WACnD,SAGR,UAGJN"}